name: Build & Release LifeRPG

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      # -------------------------------
      # CLEAN BUILD FOLDERS
      # -------------------------------
      - name: Clean build folders
        shell: powershell
        run: |
          if (Test-Path build) { Remove-Item build -Recurse -Force }
          if (Test-Path dist) { Remove-Item dist -Recurse -Force }

      # -------------------------------
      # BUILD LAUNCHER
      # -------------------------------
      - name: Build Launcher
        run: |
          pyinstaller LifeRPG_Launcher.spec --clean -y

      # -------------------------------
      # BUILD GAME
      # -------------------------------
      - name: Build Game
        run: |
          pyinstaller LifeRPG_Game.spec --clean -y

      # -------------------------------
      # CREATE FULL INSTALL ZIP
      # -------------------------------
      - name: Create full install ZIP
        shell: powershell
        run: |
          Write-Host "Dist directory contents:"
          Get-ChildItem -Recurse dist

          $exe = Get-ChildItem -Recurse dist -Filter LifeRPG.exe | Select-Object -First 1

          if (-not $exe) {
            Write-Error "LifeRPG.exe not found in dist folder"
            exit 1
          }

          Write-Host "Found EXE at:" $exe.FullName

          New-Item -ItemType Directory -Force -Path package
          Copy-Item $exe.FullName package\LifeRPG.exe

          Compress-Archive -Path package\* -DestinationPath dist\LifeRPG_full.zip -Force

          if (!(Test-Path dist\LifeRPG_full.zip)) {
            Write-Error "LifeRPG_full.zip was not created"
            exit 1
          }

      # -------------------------------
      # GENERATE MANIFEST
      # -------------------------------
      - name: Generate manifest
        shell: powershell
        run: |
          Expand-Archive dist\LifeRPG_full.zip verify -Force

          $files = Get-ChildItem verify -Recurse -File
          $manifest = @{ files = @{} }

          foreach ($file in $files) {
            $rel = $file.FullName.Substring((Resolve-Path verify).Path.Length + 1)
            $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash.ToLower()
            $manifest.files[$rel] = $hash
          }

          $manifest | ConvertTo-Json -Depth 5 | Set-Content -Path dist\manifest.json -Encoding utf8

          Write-Host "Generated manifest:"
          Get-Content dist\manifest.json

      # -------------------------------
      # UPLOAD RELEASE ASSETS
      # -------------------------------
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/LifeRPG_Launcher/LifeRPG_Launcher.exe
            dist/LifeRPG_full.zip
            dist/manifest.json
