name: Build & Release LifeRPG

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Clean build folders
        shell: powershell
        run: |
          if (Test-Path build) { Remove-Item build -Recurse -Force }
          if (Test-Path dist) { Remove-Item dist -Recurse -Force }
          if (Test-Path package) { Remove-Item package -Recurse -Force }
          if (Test-Path verify) { Remove-Item verify -Recurse -Force }

      # --------------------------------
      # Build Launcher (inject tag version)
      # --------------------------------
      - name: Build Launcher
        shell: powershell
        run: |
          $env:LAUNCHER_VERSION = "${{ github.ref_name }}"
          pyinstaller LifeRPG_Launcher.spec --clean -y

      # --------------------------------
      # Build Game (onefile)
      # --------------------------------
      - name: Build Game
        run: pyinstaller LifeRPG.spec --clean -y

      - name: Verify Game EXE
        shell: powershell
        run: |
          if (!(Test-Path "dist\LifeRPG.exe")) {
            Write-Error "Game EXE not found in dist folder"
            exit 1
          }

      # --------------------------------
      # Create Installer ZIP
      # --------------------------------
      - name: Create LifeRPG_full.zip
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path package | Out-Null
          Copy-Item dist\LifeRPG.exe package\LifeRPG.exe
          Compress-Archive -Path package\* -DestinationPath dist\LifeRPG_full.zip -Force

      # --------------------------------
      # Generate manifest.json
      # --------------------------------
      - name: Generate manifest.json
        shell: powershell
        run: |
          Expand-Archive dist\LifeRPG_full.zip verify -Force

          $files = Get-ChildItem verify -Recurse -File
          $manifest = @{ files = @{} }

          foreach ($file in $files) {
            $rel = $file.FullName.Substring((Resolve-Path verify).Path.Length + 1)
            $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash.ToLower()
            $manifest.files[$rel] = $hash
          }

          $manifest | ConvertTo-Json -Depth 5 | Set-Content dist\manifest.json -Encoding utf8

      # --------------------------------
      # Upload Release Assets
      # --------------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/LifeRPG_Launcher.exe
            dist/LifeRPG_full.zip
            dist/manifest.json
