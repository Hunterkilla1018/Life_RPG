name: Build & Release LifeRPG

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ----------------------------------------
      # Checkout
      # ----------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------
      # Setup Python
      # ----------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      # ----------------------------------------
      # Clean build folders
      # ----------------------------------------
      - name: Clean build folders
        shell: pwsh
        run: |
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path build) { Remove-Item -Recurse -Force build }

      # ----------------------------------------
      # Build Launcher
      # ----------------------------------------
      - name: Build Launcher
        run: pyinstaller LifeRPG_Launcher.spec --clean -y

      # ----------------------------------------
      # Build Game
      # ----------------------------------------
      - name: Build Game
        run: pyinstaller LifeRPG_Game.spec --clean -y

      # ----------------------------------------
      # Generate Manifest
      # ----------------------------------------
      - name: Generate manifest
        run: python scripts/generate_manifest.py

      # ----------------------------------------
      # Create Full Install ZIP
      # ----------------------------------------
      - name: Create full install ZIP
        shell: pwsh
        run: |
          if (Test-Path LifeRPG_full.zip) { Remove-Item LifeRPG_full.zip }

          if (!(Test-Path dist\LifeRPG)) {
            Write-Error "dist\LifeRPG folder missing!"
            exit 1
          }

          Compress-Archive -Path dist\LifeRPG\* `
                           -DestinationPath LifeRPG_full.zip `
                           -Force

          Write-Host "Full ZIP created successfully."

      # ----------------------------------------
      # Create Patch ZIP (Auto Diff)
      # ----------------------------------------
      - name: Create patch ZIP
        shell: pwsh
        run: |
          $currentTag = "${{ github.ref_name }}"

          git fetch --tags

          $previousTag = git tag --sort=-creatordate | Select-Object -Skip 1 -First 1

          if (-not $previousTag) {
              Write-Host "No previo
