name: Build & Release LifeRPG

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ----------------------------------------
      # Checkout
      # ----------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------
      # Setup Python
      # ----------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      # ----------------------------------------
      # Clean build folders
      # ----------------------------------------
      - name: Clean build folders
        shell: pwsh
        run: |
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path build) { Remove-Item -Recurse -Force build }

      # ----------------------------------------
      # Build Launcher
      # ----------------------------------------
      - name: Build Launcher
        run: pyinstaller LifeRPG_Launcher.spec --clean -y

      # ----------------------------------------
      # Build Game
      # ----------------------------------------
      - name: Build Launcher
        run: pyinstaller LifeRPG_Launcher.spec --clean --onefile -y


      # ----------------------------------------
      # Generate Manifest
      # ----------------------------------------
      - name: Generate manifest
        run: python scripts/generate_manifest.py

      # ----------------------------------------
      # Create Full Install ZIP
      # ----------------------------------------
      - name: Create full install ZIP
        shell: pwsh
        run: |
          if (Test-Path LifeRPG_full.zip) { Remove-Item LifeRPG_full.zip }

          if (!(Test-Path dist\LifeRPG)) {
            Write-Error "dist\LifeRPG folder missing!"
            exit 1
          }

          Compress-Archive -Path dist\LifeRPG\* `
                           -DestinationPath LifeRPG_full.zip `
                           -Force

          Write-Host "Full ZIP created successfully."

      # ----------------------------------------
      # Create Patch ZIP (Option B - Release Asset Diff)
      # ----------------------------------------
      - name: Create patch ZIP
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          # Get previous release tag
          $previousTag = gh release list --limit 2 --json tagName --jq ".[1].tagName"

          if (-not $previousTag) {
              Write-Host "No previous release found. Skipping patch."
              exit 0
          }

          Write-Host "Previous release: $previousTag"

          mkdir prev_manifest

          gh release download $previousTag `
              --pattern manifest.json `
              --dir prev_manifest `
              --clobber

          if (!(Test-Path "prev_manifest/manifest.json")) {
              Write-Host "Previous manifest not found. Skipping patch."
              exit 0
          }

          $old = Get-Content "prev_manifest/manifest.json" | ConvertFrom-Json
          $new = Get-Content manifest.json | ConvertFrom-Json

          $changed = @()

          foreach ($file in $new.files.PSObject.Properties.Name) {
              if ($old.files.$file -ne $new.files.$file) {
                  $changed += "dist\LifeRPG\$file"
              }
          }

          if ($changed.Count -eq 0) {
              Write-Host "No changed files detected."
              exit 0
          }

          Compress-Archive -Path $changed `
                           -DestinationPath LifeRPG_patch.zip `
                           -Force

          Write-Host "Patch ZIP created with $($changed.Count) changed files."

      # ----------------------------------------
      # Upload Release Assets
      # ----------------------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/LifeRPG_Launcher/LifeRPG_Launcher.exe
            LifeRPG_full.zip
            LifeRPG_patch.zip
            manifest.json
