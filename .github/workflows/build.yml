name: Build LifeRPG Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      # -------------------------------
      # Build EXE
      # -------------------------------
      - name: Build EXE
        run: |
          pyinstaller --onefile bootstrap.py --name LifeRPG

      # -------------------------------
      # Create full install ZIP (Windows-safe)
      # -------------------------------
      - name: Create full install ZIP
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path package
          Copy-Item dist\LifeRPG.exe package\

          Compress-Archive -Path package\* -DestinationPath LifeRPG_full.zip -Force

          if (!(Test-Path LifeRPG_full.zip)) {
            Write-Error "LifeRPG_full.zip was not created"
            exit 1
          }

      # -------------------------------
      # Generate expanded manifest
      # -------------------------------
      - name: Generate expanded manifest
        shell: powershell
        run: |
          Expand-Archive LifeRPG_full.zip verify -Force

          $files = Get-ChildItem verify -Recurse -File
          $manifest = @{ files = @{} }

          foreach ($file in $files) {
            $rel = $file.FullName.Substring((Resolve-Path verify).Path.Length + 1)
            $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash.ToLower()
            $manifest.files[$rel] = $hash
          }

          $manifest | ConvertTo-Json -Depth 5 | Out-File manifest.json -Encoding utf8

          Write-Host "Generated manifest:"
          Get-Content manifest.json

      # -------------------------------
      # Upload release assets
      # -------------------------------
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/LifeRPG.exe
            LifeRPG_full.zip
            manifest.json
